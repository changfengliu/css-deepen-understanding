<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>关于选择器 | 深入理解CSS</title>
    <meta name="description" content="更完备、更直观、更精简">
    
    
    <link rel="preload" href="/css-deepen-understanding/assets/css/0.styles.2ddc67ee.css" as="style"><link rel="preload" href="/css-deepen-understanding/assets/js/app.7ee76a1d.js" as="script"><link rel="preload" href="/css-deepen-understanding/assets/js/2.c8c933da.js" as="script"><link rel="preload" href="/css-deepen-understanding/assets/js/10.ed88cebe.js" as="script"><link rel="prefetch" href="/css-deepen-understanding/assets/js/11.255cb2fe.js"><link rel="prefetch" href="/css-deepen-understanding/assets/js/12.35bd4279.js"><link rel="prefetch" href="/css-deepen-understanding/assets/js/13.2ac1de05.js"><link rel="prefetch" href="/css-deepen-understanding/assets/js/14.574e3a1f.js"><link rel="prefetch" href="/css-deepen-understanding/assets/js/15.291e3379.js"><link rel="prefetch" href="/css-deepen-understanding/assets/js/16.c00c9e65.js"><link rel="prefetch" href="/css-deepen-understanding/assets/js/17.0da26fd0.js"><link rel="prefetch" href="/css-deepen-understanding/assets/js/18.aa89fe2a.js"><link rel="prefetch" href="/css-deepen-understanding/assets/js/19.097113af.js"><link rel="prefetch" href="/css-deepen-understanding/assets/js/20.dadf167d.js"><link rel="prefetch" href="/css-deepen-understanding/assets/js/21.e16ea5d5.js"><link rel="prefetch" href="/css-deepen-understanding/assets/js/22.9956ae01.js"><link rel="prefetch" href="/css-deepen-understanding/assets/js/23.760ddbea.js"><link rel="prefetch" href="/css-deepen-understanding/assets/js/24.8a527bb4.js"><link rel="prefetch" href="/css-deepen-understanding/assets/js/25.767fc54c.js"><link rel="prefetch" href="/css-deepen-understanding/assets/js/26.f061032a.js"><link rel="prefetch" href="/css-deepen-understanding/assets/js/27.bf6460bb.js"><link rel="prefetch" href="/css-deepen-understanding/assets/js/28.2eb8ab51.js"><link rel="prefetch" href="/css-deepen-understanding/assets/js/29.15131239.js"><link rel="prefetch" href="/css-deepen-understanding/assets/js/3.9dea6627.js"><link rel="prefetch" href="/css-deepen-understanding/assets/js/30.ec545159.js"><link rel="prefetch" href="/css-deepen-understanding/assets/js/31.4ac3ef21.js"><link rel="prefetch" href="/css-deepen-understanding/assets/js/32.c51c17d1.js"><link rel="prefetch" href="/css-deepen-understanding/assets/js/33.c65a0604.js"><link rel="prefetch" href="/css-deepen-understanding/assets/js/34.be97bc0d.js"><link rel="prefetch" href="/css-deepen-understanding/assets/js/35.4bbfc03f.js"><link rel="prefetch" href="/css-deepen-understanding/assets/js/36.949e29e2.js"><link rel="prefetch" href="/css-deepen-understanding/assets/js/37.95ba9468.js"><link rel="prefetch" href="/css-deepen-understanding/assets/js/38.d8cb0d6c.js"><link rel="prefetch" href="/css-deepen-understanding/assets/js/39.5de03b27.js"><link rel="prefetch" href="/css-deepen-understanding/assets/js/4.78053b49.js"><link rel="prefetch" href="/css-deepen-understanding/assets/js/5.47830973.js"><link rel="prefetch" href="/css-deepen-understanding/assets/js/6.bd73d713.js"><link rel="prefetch" href="/css-deepen-understanding/assets/js/7.92ecaa00.js"><link rel="prefetch" href="/css-deepen-understanding/assets/js/8.d33f492a.js"><link rel="prefetch" href="/css-deepen-understanding/assets/js/9.c21da5e2.js">
    <link rel="stylesheet" href="/css-deepen-understanding/assets/css/0.styles.2ddc67ee.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/css-deepen-understanding/" class="home-link router-link-active"><!----> <span class="site-name">深入理解CSS</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/css-deepen-understanding/index.html" class="nav-link">首页</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/css-deepen-understanding/index.html" class="nav-link">首页</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/css-deepen-understanding/render-model.html" class="sidebar-link">渲染模型</a></li><li><a href="/css-deepen-understanding/houdini.html" class="sidebar-link">CSS Houdini</a></li><li><a href="/css-deepen-understanding/base/main.html" class="sidebar-link">CSS 是什么</a></li><li><a href="/css-deepen-understanding/base/text.html" class="sidebar-link">CSS基础</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>动画</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>盒模型</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>专题</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>选择器</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/css-deepen-understanding/selector/main.html" class="sidebar-link">选择器</a></li><li><a href="/css-deepen-understanding/selector/selector-type.html" class="sidebar-link">选择器分类</a></li><li><a href="/css-deepen-understanding/selector/priority.html" class="sidebar-link">选择器优先级计算规则</a></li><li><a href="/css-deepen-understanding/selector/media-queries.html" class="sidebar-link">媒体查询</a></li><li><a href="/css-deepen-understanding/selector/about-selector.html" class="active sidebar-link">关于选择器</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>布局</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>一些概念</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="关于选择器"><a href="#关于选择器" class="header-anchor">#</a> 关于选择器</h1> <h4 id="为什么选择器不能子选父"><a href="#为什么选择器不能子选父" class="header-anchor">#</a> 为什么选择器不能子选父</h4> <p>看看如下几个选择器：</p> <ol><li><p><strong>child &lt; parent</strong> : 选择元素的直接父元素，跟 parent &gt; child 选择直接子元素对应。</p></li> <li><p><strong>child ^ ancestors</strong> : 选择元素的祖先们。</p></li> <li><p><strong>A - B</strong> : 选择A前面的B，即A.prev()；与 A + B 选择A后面的B对应。</p></li></ol> <p>目前CSS没有这样的选择器，是因为<strong>这样的选择器会导致回溯</strong>。</p> <p>浏览器最初设计的时候就考虑了<strong>渐进显示</strong>，即整个文档加载了多少内容就显示多少内容，而不用等待整个文档下载完。</p> <p>渐进显示在CSS上的原理就是<strong>一个节点所适用的样式只取决于它和它之前的节点（父节点、它之前的兄弟节点）的性质</strong>。</p> <p>而上述那些 selector 则恰好相反，也就是 <strong>当浏览器解析到一个新节点时，可能改变之前节点所使用的样式——因而要求在解析一个新节点后，得回头重新计算之前节点所匹配的样式，此即所谓“回溯”</strong> 。在最坏的情况下所导致大量的重新计算和reflow，可以相当于重新render整个网页。</p> <p>所以 CSS 直到2.1都没有任何可能引起回溯的 selector。但是selector 3就开了口子。比如: <strong>last-child</strong>。考虑如下规则：</p> <div class="language-CSS extra-class"><pre class="language-css"><code><span class="token selector">div:last-child</span> <span class="token punctuation">{</span>
	<span class="token property">display</span><span class="token punctuation">:</span>none
<span class="token punctuation">}</span>
</code></pre></div><p>CSS2 的所有 selector 在 &lt;div attributes&gt; 的 start tag 结束后就确定是否匹配了，但是对于 <strong>:last-child</strong> 伪类，要判断这条规则是否适用，至少是在 &lt;/div&gt; 之后再读入一个 tag 才行（是父元素的end tag则匹配，反之不匹配）。假设一个div是整个页面的container，那么就导致在页面没有加载完时能看见div（前提是浏览器已经渐进显示了部分内容），而在加载完后就看不见了。</p> <p>类似的，考虑 <strong>x:empty</strong> ，比 :last-child 好点，在解析到 &lt;/x&gt; 时就可以确定了，而不用再读一个tag。</p> <p>而 <strong>:nth-last-child()</strong> 则就比 :last-child 要更困难，得等整个父元素结束。</p> <h4 id="为什么是从右向左解析选择器的"><a href="#为什么是从右向左解析选择器的" class="header-anchor">#</a> 为什么是从右向左解析选择器的</h4> <p>首先我们要看一下选择器的「解析」是在何时进行的。</p> <p><img src="/css-deepen-understanding/assets/img/webkit-render.5e17c466.jpg" alt=""></p> <p>HTML 经过解析生成 <strong>DOM Tree</strong>；而在 CSS 解析完毕后，需要将解析的结果与 DOM Tree 的内容一起进行分析建立一棵 <strong>Render Tree</strong>，最终用来进行绘图。</p> <p>Render Tree 中的元素（WebKit 中称为「renderers」，Firefox 下为「frames」）与 DOM 元素相对应，但非一一对应：一个 DOM 元素可能会对应多个 renderer，如文本折行后，不同的「行」会成为 render tree 中不同的 renderer。也有的 DOM 元素被 Render Tree 完全无视，比如 display:none 的元素。</p> <p>在建立 Render Tree 时（WebKit 中的「Attachment」过程），浏览器就要为每个 DOM Tree 中的元素根据 CSS 的解析结果（Style Rules）来确定生成怎样的 renderer。<strong>对于每个 DOM 元素，必须在所有 Style Rules 中找到符合的 selector 并将对应的规则进行合并</strong>。选择器的「解析」实际是在这里执行的，在遍历 DOM Tree 时，从 Style Rules 中去寻找对应的 selector。</p> <p>因为所有样式规则可能数量很大，而且绝大多数不会匹配到当前的 DOM 元素（因为数量很大所以一般会建立规则索引树），所以有一个快速的方法来判断「这个 selector 不匹配当前元素」就是极其重要的。</p> <p>如果正向解析，例如「div div p em」，我们首先就要检查当前元素到 html 的整条路径，找到最上层的 div，再往下找，如果遇到不匹配就必须回到最上层那个 div，往下再去匹配选择器中的第一个 div，回溯若干次才能确定匹配与否，效率很低。</p> <p><strong>逆向匹配则不同，如果当前的 DOM 元素是 div，而不是 selector 最后的 em，那只要一步就能排除。只有在匹配时，才会不断向上找父节点进行验证。</strong></p> <p>但因为匹配的情况远远低于不匹配的情况，所以逆向匹配带来的优势是巨大的。</p> <p>同时我们也能够看出，在选择器结尾加上「*」就大大降低了这种优势，这也就是很多优化原则提到的尽量避免在选择器末尾添加通配符的原因。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/css-deepen-understanding/selector/media-queries.html" class="prev">媒体查询</a></span> <span class="next"><a href="/css-deepen-understanding/layout/main.html">布局</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/css-deepen-understanding/assets/js/app.7ee76a1d.js" defer></script><script src="/css-deepen-understanding/assets/js/2.c8c933da.js" defer></script><script src="/css-deepen-understanding/assets/js/10.ed88cebe.js" defer></script>
  </body>
</html>
